rules_version = '2';

// ============================================================================
// Urban Points Lebanon - Production Firestore Security Rules
// Generated: Autonomous Deployment Session
// Project: urbangenspark
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isMerchant(merchantId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/merchants/$(merchantId)) &&
             request.auth.uid == merchantId;
    }
    
    function isCustomer() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/customers/$(request.auth.uid));
    }
    
    // ========================================================================
    // CUSTOMERS COLLECTION
    // ========================================================================
    
    match /customers/{customerId} {
      allow read: if isOwner(customerId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == customerId;
      allow update: if isOwner(customerId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // MERCHANTS COLLECTION
    // ========================================================================
    
    match /merchants/{merchantId} {
      // Public read for merchant directory
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isMerchant(merchantId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // ADMINS COLLECTION (Read-only, managed by Cloud Functions)
    // ========================================================================
    
    match /admins/{adminId} {
      allow read: if isOwner(adminId) || isAdmin();
      allow write: if false; // Only Cloud Functions can write
    }
    
    // ========================================================================
    // OFFERS/REWARDS COLLECTION
    // Qatar Spec Requirement 5: Admin approval workflow enforcement
    // ========================================================================
    
    match /offers/{offerId} {
      // Public read for active AND approved offers
      allow read: if (resource.data.is_active == true && resource.data.status == 'approved') || 
                     resource.data.merchant_id == request.auth.uid ||
                     isAdmin();
      
      // Merchants can create offers, but they start as PENDING
      allow create: if isAuthenticated() && 
                       request.resource.data.merchant_id == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.is_active == false;
      
      // Merchants can update their own offers, but CANNOT change status or activate
      allow update: if resource.data.merchant_id == request.auth.uid && 
                       request.resource.data.status == resource.data.status &&
                       request.resource.data.is_active == resource.data.is_active &&
                       request.resource.data.merchant_id == resource.data.merchant_id;
      
      // Only admins can approve/reject and activate offers
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // QR_TOKENS COLLECTION (Cloud Functions Only)
    // ========================================================================
    
    match /qr_tokens/{tokenId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        resource.data.merchant_id == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // REDEMPTIONS COLLECTION (Cloud Functions Only)
    // ========================================================================
    
    match /redemptions/{redemptionId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        resource.data.merchant_id == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // SUBSCRIPTIONS COLLECTION
    // ========================================================================
    
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // SUBSCRIPTION_PLANS COLLECTION
    // ========================================================================
    
    match /subscription_plans/{planId} {
      allow read: if true; // Public
      allow write: if isAdmin();
    }
    
    // ========================================================================
    // PAYMENT_TRANSACTIONS COLLECTION
    // ========================================================================
    
    match /payment_transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // PUSH_CAMPAIGNS COLLECTION
    // ========================================================================
    
    match /push_campaigns/{campaignId} {
      allow read, write: if isAdmin();
    }
    
    // ========================================================================
    // NOTIFICATIONS COLLECTION
    // ========================================================================
    
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // DAILY_STATS COLLECTION
    // ========================================================================
    
    match /daily_stats/{date} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // OTP_CODES COLLECTION (Cloud Functions Only)
    // ========================================================================
    
    match /otp_codes/{otpId} {
      allow read, write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // SMS_LOG COLLECTION (Admin Only)
    // ========================================================================
    
    match /sms_log/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // CAMPAIGN_LOGS COLLECTION (Admin Only)
    // ========================================================================
    
    match /campaign_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // SUBSCRIPTION_METRICS COLLECTION (Admin Only)
    // ========================================================================
    
    match /subscription_metrics/{metricId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // SUBSCRIPTION_RENEWAL_LOGS COLLECTION (Admin Only)
    // ========================================================================
    
    match /subscription_renewal_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // PAYMENT_WEBHOOKS COLLECTION (Cloud Functions Only)
    // ========================================================================
    
    match /payment_webhooks/{webhookId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // TRANSACTIONS COLLECTION (for backward compatibility)
    // ========================================================================
    
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        resource.data.merchant_id == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // REWARDS COLLECTION (alias for offers)
    // ========================================================================
    
    match /rewards/{rewardId} {
      allow read: if resource.data.is_active == true || 
                     resource.data.merchant_id == request.auth.uid ||
                     isAdmin();
      allow create: if isAuthenticated();
      allow update: if resource.data.merchant_id == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // REFERRALS COLLECTION
    // ========================================================================
    
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && (
        resource.data.referrer_id == request.auth.uid ||
        resource.data.referee_id == request.auth.uid ||
        isAdmin()
      );
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // SYSTEM_ALERTS COLLECTION (Admin Only)
    // ========================================================================
    
    match /system_alerts/{alertId} {
      allow read, write: if isAdmin();
    }
    
    // ========================================================================
    // RATE_LIMITS COLLECTION (Cloud Functions Only)
    // Qatar Spec Requirement 6: Abuse prevention storage
    // ========================================================================
    
    match /rate_limits/{limitId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ========================================================================
    // DEFAULT DENY ALL
    // ========================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
