# BLOCKER — BACKEND-SECURITY-001

**Requirement:** FCM Token Registration via Backend  
**Status:** BLOCKED  
**Category:** Security, Backend Architecture  

---

## Why BLOCKED

The customer and merchant apps currently write FCM tokens directly to Firestore's `user_tokens` collection, bypassing the backend validation layer (`registerFCMTokenCallable`). Refactoring this requires:

1. **Backend**: Implement `registerFCMTokenCallable` with rate limiting, token validation, and max token limits (5 per user)
2. **Customer App**: Refactor `fcm_service.dart:saveTokenToFirestore` to call the backend callable instead of direct Firestore write
3. **Merchant App**: Refactor `fcm_service.dart:saveTokenToFirestore` to call the backend callable instead of direct Firestore write
4. **Testing**: Add unit tests for token registration, validation, rate limiting logic
5. **Security Rules**: Update Firestore rules to prevent direct client writes to `user_tokens` collection

This is a **cross-app refactoring** requiring:
- Backward compatibility handling (existing tokens in Firestore)
- Changes to 3 separate codebases (backend + 2 apps)
- Test coverage updates

## Evidence Required

- ✅ Backend callable `registerFCMTokenCallable` in source/backend/firebase-functions/src/fcm.ts with:
  - Token validation and sanitization
  - Rate limiting (e.g., max 1 registration per minute per user)
  - Max token limits (5 per user)
  - Proper error handling
- ✅ Customer app refactored to call callable instead of direct Firestore write
- ✅ Merchant app refactored to call callable instead of direct Firestore write
- ✅ Unit tests for backend callable
- ✅ Integration tests for app→backend→Firestore flow
- ✅ Firestore security rules updated to enforce backend-only writes

## Next Steps

1. Implement `registerFCMTokenCallable` in backend with rate limiting
2. Refactor both apps to call the new callable
3. Add comprehensive test coverage
4. Update security rules
5. Test with real FCM token lifecycle (register, update, delete)

---

**Document Created:** 2026-01-16  
**Auto-generated by:** Phase 3 Implementation
