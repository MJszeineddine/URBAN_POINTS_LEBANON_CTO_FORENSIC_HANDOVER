# Reality Lock Report — Urban Points Lebanon
**Date:** 2026-01-06  
**Repo:** /Users/mohammadzeineddine/Downloads/URBAN_POINTS_LEBANON_CTO_FORENSIC_HANDOVER

## Executive Snapshot
- Baseline requires phone OTP + subscription-gated offers; baseline reference confirms OTP + monthly subs for customers/merchants [docs/parity/QATAR_OBSERVED_BASELINE.md#L14-L56](docs/parity/QATAR_OBSERVED_BASELINE.md#L14-L56). Repo mobile apps implement only email/password auth; no OTP methods in customer AuthService (auth flows only) [source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120](source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120).
- Customer and merchant UI screens exist but core wiring to earn/redeem/balance/history and subscription gating is missing; offers list uses local repository and location service, no callable functions [source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L120](source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L120). Merchant create offer calls createOffer callable but lacks subscription check [source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430](source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430).
- Admin web app absent; Kanban marks AW-01..AW-09 blocked/deferred to Firebase Console [KANBAN_BOARD.md#L240-L330](KANBAN_BOARD.md#L240-L330).
- Backend Functions implement offers/points/QR engines with validation/rate-limit helpers and Zod schemas (4 functions covered) [source/backend/firebase-functions/src/core/points.ts#L40-L140](source/backend/firebase-functions/src/core/points.ts#L40-L140), [source/backend/firebase-functions/src/core/offers.ts#L60-L140](source/backend/firebase-functions/src/core/offers.ts#L60-L140), [source/backend/firebase-functions/src/core/qr.ts#L20-L150](source/backend/firebase-functions/src/core/qr.ts#L20-L150), [source/backend/firebase-functions/src/validation/schemas.ts#L1-L80](source/backend/firebase-functions/src/validation/schemas.ts#L1-L80).
- Stripe webhook with signature verification and processed_webhooks idempotency is coded but depends on STRIPE_SECRET_KEY/STRIPE_WEBHOOK_SECRET env; not deployable without secrets/IAM [source/backend/firebase-functions/src/stripe.ts#L350-L470](source/backend/firebase-functions/src/stripe.ts#L350-L470).
- Firestore rules present but allow public merchant reads and lack App Check; QR/redemptions write locked to Functions only [source/infra/firestore.rules#L20-L150](source/infra/firestore.rules#L20-L150).
- Firestore indexes file defines composites for redemptions/offers/qr_tokens/subscriptions [source/infra/firestore.indexes.json#L1-L120](source/infra/firestore.indexes.json#L1-L120).
- Gates: env_gate checks Node/npm/Java and frees emulator ports [tools/env_gate.sh#L1-L120](tools/env_gate.sh#L1-L120); phase3_gate asserts scheduler/notification files/tests and runs build/test [tools/phase3_gate.sh#L20-L170](tools/phase3_gate.sh#L20-L170); fullstack_gate orchestrates builds/tests Flutter/REST/Functions and dry-run deploy with evidence logging [tools/fullstack_gate.sh#L1-L210](tools/fullstack_gate.sh#L1-L210).
- Kanban shows 9 cards blocked by Firebase deploy permissions and 6 by Stripe secrets; completion 31% overall [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520).

## App Map
- Customer App (Flutter)
  - Entry: lib/main.dart (not inspected here). Auth only (email/password/Google); no earn/redeem/balance methods in service [source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120](source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120).
  - Offers UI uses OffersRepository + LocationService; no callable integration shown [source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L120](source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L120).
- Merchant App (Flutter)
  - Auth service mirrors customer (email/password/Google) [source/apps/mobile-merchant/lib/services/auth_service.dart#L1-L120](source/apps/mobile-merchant/lib/services/auth_service.dart#L1-L120).
  - Create offer screen calls Cloud Function createOffer but no subscription/paywall enforcement [source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430](source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430).
- Admin App (Flutter)
  - Placeholder per reality map; no service layer (not present in inspected paths).
- Backend Functions (Firebase)
  - Exports auth/offers/points/QR/stripe, etc. [source/backend/firebase-functions/src/index.ts#L1-L60](source/backend/firebase-functions/src/index.ts#L1-L60).
  - Points engine with idempotency and transactions [source/backend/firebase-functions/src/core/points.ts#L80-L160](source/backend/firebase-functions/src/core/points.ts#L80-L160).
  - Offers engine create/validate workflow [source/backend/firebase-functions/src/core/offers.ts#L60-L140](source/backend/firebase-functions/src/core/offers.ts#L60-L140).
  - QR token generation with 60s expiry + one-time PIN + rate limit [source/backend/firebase-functions/src/core/qr.ts#L20-L150](source/backend/firebase-functions/src/core/qr.ts#L20-L150).
  - Stripe webhook with signature verification and processed_webhooks idempotency [source/backend/firebase-functions/src/stripe.ts#L350-L470](source/backend/firebase-functions/src/stripe.ts#L350-L470).
  - Zod validation schemas for 4 functions [source/backend/firebase-functions/src/validation/schemas.ts#L1-L80](source/backend/firebase-functions/src/validation/schemas.ts#L1-L80).
- REST API
  - Package with build/test scripts defined; Node18 engines [source/backend/rest-api/package.json#L1-L60](source/backend/rest-api/package.json#L1-L60).
- Infra
  - Firestore rules [source/infra/firestore.rules#L1-L200](source/infra/firestore.rules#L1-L200).
  - Firestore indexes [source/infra/firestore.indexes.json#L1-L120](source/infra/firestore.indexes.json#L1-L120).
- Gates
  - env_gate [tools/env_gate.sh#L1-L160](tools/env_gate.sh#L1-L160); phase3_gate [tools/phase3_gate.sh#L20-L170](tools/phase3_gate.sh#L20-L170); fullstack_gate [tools/fullstack_gate.sh#L1-L210](tools/fullstack_gate.sh#L1-L210).

## Baseline Coverage Matrix
Values: DONE / PARTIAL / MISSING / UNKNOWN / OUT-OF-MVP

| Baseline Feature | Customer App | Merchant App | Admin App | Functions | DB | Security Rules | DevOps |
| --- | --- | --- | --- | --- | --- | --- | --- |
| Auth (phone OTP) | MISSING (email/pw only, no OTP methods) [source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120](source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120) | MISSING (same) [source/apps/mobile-merchant/lib/services/auth_service.dart#L1-L120](source/apps/mobile-merchant/lib/services/auth_service.dart#L1-L120) | MISSING (admin app absent) [KANBAN_BOARD.md#L240-L330](KANBAN_BOARD.md#L240-L330) | PARTIAL (sendOTP/verifyOTP coded, provider unconfigured) [source/backend/firebase-functions/src/index.ts#L40-L60](source/backend/firebase-functions/src/index.ts#L40-L60) | PARTIAL (otp_codes collection referenced) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L140-L200](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L140-L200) | PARTIAL (otp_codes writes blocked to Functions, no App Check) [source/infra/firestore.rules#L150-L200](source/infra/firestore.rules#L150-L200) | MISSING (no deploy/secret setup for SMS) |
| Subscription gating (customer+merchant) | MISSING (no subscription checks in UI) [source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120](source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120) | MISSING (create offer callable invoked without access check) [source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430](source/apps/mobile-merchant/lib/screens_create_offer_screen.dart#L380-L430) | MISSING (no admin app) [KANBAN_BOARD.md#L240-L330](KANBAN_BOARD.md#L240-L330) | PARTIAL (checkSubscriptionAccess + webhook sync coded) [source/backend/firebase-functions/src/stripe.ts#L350-L470](source/backend/firebase-functions/src/stripe.ts#L350-L470) | PARTIAL (subscriptions collection defined) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120) | PARTIAL (subscriptions read allowed; no App Check) [source/infra/firestore.rules#L120-L150](source/infra/firestore.rules#L120-L150) | MISSING (Stripe secrets/deploy blocked) [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520) |
| Offer creation + admin approval | MISSING (customer cannot create) | PARTIAL (createOffer callable used; no subscription paywall) [source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430](source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L380-L430) | MISSING (admin UI absent) [KANBAN_BOARD.md#L240-L330](KANBAN_BOARD.md#L240-L330) | DONE (createOffer + status workflow) [source/backend/firebase-functions/src/core/offers.ts#L60-L140](source/backend/firebase-functions/src/core/offers.ts#L60-L140) | DONE (offers schema) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L40-L70](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L40-L70) | PARTIAL (rules enforce pending/approved, public read active) [source/infra/firestore.rules#L60-L110](source/infra/firestore.rules#L60-L110) | PARTIAL (build scripts exist; deploy blocked) [tools/fullstack_gate.sh#L120-L180](tools/fullstack_gate.sh#L120-L180) |
| Offer types (B1G1/%/fixed) | PARTIAL (UI placeholders, no backend link) [source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L120](source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L120) | PARTIAL (form captures discounts; backend pointsValue supports) [source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L20-L120](source/apps/mobile-merchant/lib/screens/create_offer_screen.dart#L20-L120) | MISSING | DONE (offers supports categories/points) [source/backend/firebase-functions/src/core/offers.ts#L60-L140](source/backend/firebase-functions/src/core/offers.ts#L60-L140) | DONE (offers fields incl points_value/category) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L40-L70](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L40-L70) | PARTIAL (rules allow public read active/approved) [source/infra/firestore.rules#L60-L110](source/infra/firestore.rules#L60-L110) | PARTIAL (buildable, deploy blocked) [tools/fullstack_gate.sh#L120-L180](tools/fullstack_gate.sh#L120-L180) |
| Redemption (QR short TTL + merchant scan + PIN) | MISSING (no QR callable usage) [source/apps/mobile-customer/lib/services/auth_service.dart#L1-L120](source/apps/mobile-customer/lib/services_auth_service.dart#L1-L120) | MISSING (QR scanner not integrated in screens) [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L230-L280](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L230-L280) | MISSING | DONE (QR gen 60s + one-time PIN + rate limit) [source/backend/firebase-functions/src/core/qr.ts#L20-L150](source/backend/firebase-functions/src/core/qr.ts#L20-L150) | DONE (qr_tokens collection) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120) | PARTIAL (write blocked to Functions; no App Check) [source/infra/firestore.rules#L100-L140](source/infra/firestore.rules#L100-L140) | PARTIAL (tests exist; deploy blocked) [tools/fullstack_gate.sh#L120-L190](tools/fullstack_gate.sh#L120-L190) |
| Redemption history & “Used” marking | MISSING (history screen not wired) [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L90-L150](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L90-L150) | MISSING (analytics/history not wired) [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L230-L280](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L230-L280) | MISSING | DONE (redemptions recorded with status + idempotency) [source/backend/firebase-functions/src/core/points.ts#L110-L190](source/backend/firebase-functions/src/core/points.ts#L110-L190) | DONE (redemptions collection) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120) | PARTIAL (reads allowed to owner/admin) [source/infra/firestore.rules#L110-L140](source/infra/firestore.rules#L110-L140) | PARTIAL (build/test scripts only) [tools/fullstack_gate.sh#L120-L180](tools/fullstack_gate.sh#L120-L180) |
| Location prioritization + national catalog | PARTIAL (LocationService used, shows national fallback) [source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L80](source/apps/mobile-customer/lib/screens/offers_list_screen.dart#L18-L80) | UNKNOWN (no location logic evident) | MISSING | UNKNOWN (no geo prioritization found in backend snippets) | UNKNOWN (no geo indexes) | MISSING (rules lack geo constraints) [source/infra/firestore.rules#L1-L200](source/infra/firestore.rules#L1-L200) | MISSING |
| Notifications (usage confirmation + renewal reminders + new offers) | PARTIAL (FCM service exists; token not registered) [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L120-L180](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L120-L180) | MISSING (no token/handlers) [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L230-L280](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L230-L280) | MISSING | PARTIAL (pushCampaigns + notify triggers coded) [docs/CTO_HANDOVER/01_reality_map/backend_reality.md#L260-L320](docs/CTO_HANDOVER/01_reality_map/backend_reality.md#L260-L320) | PARTIAL (notifications, push_campaigns collections) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L100-L140](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L100-L140) | PARTIAL (rules allow user read, admin write) [source/infra/firestore.rules#L160-L200](source/infra/firestore.rules#L160-L200) | MISSING (no monitoring/FCM config in gates) |
| Payments (Stripe code + webhook + secrets + plan enforcement) | MISSING (no payment UI) | MISSING (no PaymentSheet wiring) | MISSING | PARTIAL (webhook + subscription sync; secrets missing) [source/backend/firebase-functions/src/stripe.ts#L350-L470](source/backend/firebase-functions/src/stripe.ts#L350-L470) | PARTIAL (subscriptions, processed_webhooks) [docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120](docs/CTO_HANDOVER/01_reality_map/database_reality.md#L70-L120) | PARTIAL (rules allow read; no secret enforcement) [source/infra/firestore.rules#L120-L150](source/infra/firestore.rules#L120-L150) | MISSING (deploy/secret setup blocked) [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520) |

## Readiness Gates
- env_gate: validates Node>=18, npm, Java; frees emulator ports 8080/9099/etc and normalizes emulator hosts [tools/env_gate.sh#L1-L140](tools/env_gate.sh#L1-L140). Failure blocks gate with BLOCKER_ENV_GATE message.
- phase3_gate: asserts presence/exports of phase3Scheduler/phase3Notifications, runs npm build and test:ci, checks console usage and rules coverage [tools/phase3_gate.sh#L20-L170](tools/phase3_gate.sh#L20-L170). Exits non-zero on missing files/tests/build failures.
- fullstack_gate: orchestrates env_gate + phase3_gate, builds functions/rest, runs tests, runs Flutter analyze/test (skips if no SDK), attempts firebase deploy --dry-run if creds; logs to docs/parity/evidence/fullstack/<ts>/ [tools/fullstack_gate.sh#L1-L210](tools/fullstack_gate.sh#L1-L210). Final status GO/NO-GO determined by build/test/deploy exits.
- Buildable now: Functions and REST API have scripts (`npm run build`, `npm run test:ci`/`npm test`) defined [tools/fullstack_gate.sh#L120-L180](tools/fullstack_gate.sh#L120-L180), [source/backend/rest-api/package.json#L10-L40](source/backend/rest-api/package.json#L10-L40). Deployable: NO (deploy step blocked by missing Firebase IAM/secrets) [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520).

## Hard Blockers
- Deploy permissions: firebase deploy returns 403; cannot ship functions/webhook. Evidence: Kanban BE-10/PAY-07 blocked by permissions [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520). Fix: grant roles firebase.admin, cloudfunctions.admin, secretmanager.admin to service account and rerun deploy.
- Stripe secrets unset: STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET not configured; webhook handler early-exits [source/backend/firebase-functions/src/stripe.ts#L360-L400](source/backend/firebase-functions/src/stripe.ts#L360-L400). Fix: `firebase functions:secrets:set STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` after IAM fixed.
- Admin web absent: no AW implementation; moderation/compliance/analytics missing [KANBAN_BOARD.md#L240-L330](KANBAN_BOARD.md#L240-L330). Fix: build Next.js admin or formally accept Firebase Console-only scope.
- Mobile wiring missing: customer earn/redeem/balance/history and merchant QR/analytics not connected to backend [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L30-L280](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L30-L280). Fix: add callable integrations per Kanban CA-08..11, MA-07..10.
- App Check not enforced: rules lack App Check; increases abuse risk [source/infra/firestore.rules#L1-L200](source/infra/firestore.rules#L1-L200). Fix: enable App Check in apps and rules.

## Scope Decisions (MVP vs Post-MVP)
- Admin web app deferred; Firebase Console used for moderation/user management/alerts/analytics [KANBAN_BOARD.md#L260-L330](KANBAN_BOARD.md#L260-L330).
- OMT/Whish payment webhooks disabled; Stripe only for MVP [docs/CTO_HANDOVER/01_reality_map/backend_reality.md#L210-L240](docs/CTO_HANDOVER/01_reality_map/backend_reality.md#L210-L240).
- Scheduled automation (subscription renewals, cleanup) disabled pending Cloud Scheduler enablement [docs/CTO_HANDOVER/01_reality_map/backend_reality.md#L210-L240](docs/CTO_HANDOVER/01_reality_map/backend_reality.md#L210-L240).
- Arabic localization, referral program, offline queue flagged as backlog (post-MVP) [KANBAN_BOARD.md#L140-L200](KANBAN_BOARD.md#L140-L200).

## Next Minimal Sprint to GO (max 12 cards)
1) DO-01: Fix Firebase deploy IAM — Files: project IAM; Acceptance: `firebase deploy --only functions --dry-run` succeeds [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520).
2) BE-11: Set STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET — Files: Firebase secrets; Acceptance: `firebase functions:secrets:get STRIPE_SECRET_KEY` shows value [source/backend/firebase-functions/src/stripe.ts#L360-L400](source/backend/firebase-functions/src/stripe.ts#L360-L400).
3) BE-12/13: Deploy stripeWebhook and register in Stripe dashboard — Files: stripe.ts; Acceptance: live endpoint responds 200 to verified test event [source/backend/firebase-functions/src/stripe.ts#L350-L470](source/backend/firebase-functions/src/stripe.ts#L350-L470).
4) CA-08/09/10/11: Wire customer offers, redeem, history, QR gen to callables — Files: source/apps/mobile-customer/lib/screens/*; Acceptance: manual flow signup→browse→redeem→history works against emulator.
5) MA-07/08/09/10: Add subscription paywall, wire create offer, my offers, QR scanner — Files: source/apps/mobile-merchant/lib/screens/*; Acceptance: merchant without subscription blocked; with subscription can create offer and validate QR.
6) SEC-08/09: Extend Zod validation + rate limiting to all functions — Files: validation/schemas.ts, middleware; Acceptance: all callable inputs validated, rate limits configured in code.
7) BE-16/17/18: Add jest tests for offers/redemption/stripe — Files: source/backend/firebase-functions/src/__tests__/*; Acceptance: `npm run test:ci` passes with added cases.
8) DB-05: Confirm/deploy indexes for offers/redemptions/qr_tokens — Files: source/infra/firestore.indexes.json; Acceptance: `firebase firestore:indexes` deploy succeeds, no missing-index errors.
9) SEC-10/12: Harden rules + enable App Check — Files: source/infra/firestore.rules; Acceptance: emulator tests deny cross-user reads; App Check enforced in clients.
10) PAY-09/10: Stripe CLI test events + create test subscriptions — Files: stripe.ts; Acceptance: Firestore subscriptions/merchants update on triggers.
11) DO-03: Add CI to run fullstack_gate with deploy SKIP — Files: .github/workflows/main.yml; Acceptance: CI green running builds/tests and logs artifacts.
12) AW-01..05 (if required for GO): Scaffold Next.js admin with RBAC/moderation/audit/export — Files: source/apps/web-admin; Acceptance: npm run build succeeds and dashboard shows moderation table.

## Resolved Items (this run)
- Installed backend dependencies via npm ci for firebase-functions and rest-api; vulnerabilities remain to be triaged.
- env_gate passed; environment validated (Node 20, npm 10, Java 17, emulator ports free).
- Captured fullstack_gate evidence; verified deploy dry-run blocked by missing ADC/credentials and stripe secrets; deploy logged as BLOCKER_DEPLOY_AUTH.

## Verdict
**NO-GO** — Deploy/secret blockers prevent backend release [KANBAN_BOARD.md#L450-L520](KANBAN_BOARD.md#L450-L520); mobile apps lack redemption/subscription wiring [docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L30-L280](docs/CTO_HANDOVER/01_reality_map/frontend_reality.md#L30-L280); admin web absent (moderation/compliance missing) [KANBAN_BOARD.md#L240-L330](KANBAN_BOARD.md#L240-L330).
